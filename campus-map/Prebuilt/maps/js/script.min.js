var doc=document,win=window,$doc=$(document),$win=$(window),container=doc.getElementById("container"),body=doc.getElementsByTagName("body")[0],canvas=doc.getElementById("map_canvas"),doResize,categoryFile="Prebuilt/maps/data/categories.txt",objectFile="Prebuilt/maps/data/objectFile.txt",myLatlng,myOptions,map,parkingLayer,infoWindow,iconpath="Prebuilt/maps/imgs/icons/numeral-icons/",campusLayer,campusFile="http://www.byui.edu/Prebuilt/maps/campus_outline.xml"; var control={menuState:1,currentDevice:0,categoryState:[]};var categoryInfo=[],mapCategories=[],fullMapCategories=[],markerArray=[];function getHeight(object){return object.height()}function setHeight(object,height){object.style.height=height}function getMapHeight(){var bodyHeight=$("body").height(),titleHeight=$("#title").height(),mapHeight=bodyHeight-titleHeight+"px";return mapHeight}function setMapHeight(){$("#container").height(getMapHeight());$("#map_canvas").height(getMapHeight())} function detectDevice(){var width=doc.body.offsetWidth;if(width<800)return 0;else return 1}function setDevice(changeTo,callback){var deviceIndicator=doc.getElementById("device_type"),body=doc.getElementsByTagName("body")[0];if(changeTo===0){control.currentDevice=0;body.setAttribute("id","mobile")}else{control.currentDevice=1;body.setAttribute("id","desktop")}setMapHeight();if(callback&&typeof callback==="function")callback()} function toggleDevice(){var current=control.currentDevice;if(current===0)setDevice(1);else setDevice(0)}function setCurrentDevice(){if(control.currentDevice===0)setDevice(0);else setDevice(1)}function setAllControls(){var device=detectDevice();control.currentDevice=device;setCurrentDevice();resizeStack()}function loadCategoryInfoFile(callback){$.ajax({dataType:"json",url:categoryFile,success:function(data){categoryInfo=data}}).done(callback).fail(function(){})} function loadCategoryFile(callback){$.ajax({dataType:"json",url:objectFile,success:function(data){mapCategories=data,fullMapCategories=$.extend(true,[],mapCategories)}}).done(callback).fail(function(){})}function loadCatData(callback){loadCategoryInfoFile();loadCategoryFile();if(callback&&typeof callback==="function")callback()} function loadProgress(percentageComplete,callback){var obj=doc.getElementById("loading_progress");obj.style.width=percentageComplete+"%";if(callback&&typeof callback==="function")callback()}function loadComplete(callback){loadProgress(100);var loadingDiv=$("#loading"),device=control.currentDevice;loadingDiv.fadeOut(1E3);if(callback&&typeof callback==="function")callback();console.timeEnd("initialize js chain until ready")} function createMarker(lat,lon,name,icon){var marker=new google.maps.Marker({position:new google.maps.LatLng(lat,lon),visible:false,map:map,title:name,icon:icon});return marker} function buildCatObject(i,catIndex,name,color,code){var thishtml="";thishtml+='<a id="obj_'+catIndex+"-"+i+'" class="object marker_object" name="'+name+'" href="#'+code+'">';thishtml+='<img class="obj_icon" src="Prebuilt/maps/imgs/icons/numeral-icons/'+color+"/"+(i+1)+'.png" alt="'+name+'" />';thishtml+='<div class="object_name">'+name+"</div>";thishtml+="</a>";return thishtml} function createInfoWindow(marker,obj,catName){google.maps.event.addListener(marker,"click",function(){var content="",name=obj.name,img,link=obj.link,hours=obj.hours,phone=obj.phone,address=obj.address,info=obj.info,device=control.currentDevice;if(obj.img)if(obj.img.indexOf(":")===-1)img="Prebuilt/maps/imgs/objects/"+catName+"/"+obj.img;else img=obj.img;content+='<div class="infopane';if(device===0)content+=' infopane-mobile">';else content+=' infopane-desktop">';content+="<h2>"+name+"</h2>";content+= "<div>";if(img){content+='<img src="'+img+'" alt="'+name+'"';if(device===0)content+='width="100" height="75"';else content+='width="200" height="150"';content+='style="float:right;margin:0 0 10px 10px"/>'}content+='<div class="button-div">';if(phone)content+='<a class="phone-call btn btn-large btn-primary icon-call" href="tel:'+phone+'" ></a>';if(link)content+='<a href="'+link+'" target="_blank" class="btn btn-large btn-primary">More Info</a>';content+="</div>";if(hours)content+='<div class="info-row info-hours"><strong>Hours:</strong> '+ hours+"</div>";if(phone)content+='<div class="info-row info-phone"><strong>Phone:</strong> '+phone+"</div>";if(address)content+='<div class="info-row info-address"><strong>Address:</strong> '+address+"</div>";if(info)content+='<div class="info-row info-info"><strong>Info:</strong> '+info+"</div>";content+="</div>";content+="</div>";content+='<div class="addthis_toolbox addthis_32x32_style addthis_default_style">';content+="<p>Share this location.</p>";content+='<a class="addthis_button_facebook social_button"></a>'; content+='<a class="addthis_button_google_plusone_share social_button"></a>';content+='<a class="addthis_button_twitter social_button"></a>';content+='<a class="addthis_button_compact social_button"></a>';content+="</div>";infoWindow.setContent(content);infoWindow.open(map,marker);var addthis_share={url:"http://www2.byui.edu/Maps/campus-map/index.html#"+obj.code,title:obj.name};addthis.toolbox(".addthis_toolbox",{},addthis_share)})} function displayPoint(marker){var moveEnd=google.maps.event.addListener(map,"moveend",function(){var markerOffset=map.fromLatLngToDivPixel(marker.getPosition());google.maps.event.removeListener(moveEnd)});map.panTo(marker.getPosition());google.maps.event.trigger(marker,"click")} function populateCategoryInfo(callback){var target=doc.getElementById("categories"),html="",mapKeyTarget=doc.getElementById("map_keys"),length=categoryInfo.length,thisCat,state,i=0,catID;while(i<length){thisCat=categoryInfo[i];html+='<div class="category" id="cat_'+i+'">';if(categoryInfo[i].type===0)html+='<a class="category_bar" href="#" >';else{html+='<a class="category_bar cat_polygon" href="#" >';mapKeyTarget.innerHTML+='<div id="poly_key_'+i+'" class="map_key_category map_key_'+thisCat.name+ '"><div class="key_title">'+thisCat.name+' Map Key</div><a href="#" class="close icon-cancel nolink"></a></div>'}html+='<img class="cat_icon" src="Prebuilt/maps/imgs/icons/blank-colors/'+thisCat.icon+'.png" />';html+='<span class="category_name">'+thisCat.title+"</span>";html+="</a>";html+='<div class="cat_container">';html+='<div class="cat_info">';html+="<p>";html+=thisCat.text;html+="</p>";html+='<a href="'+thisCat.link+'" target="_blank">'+thisCat.title+" website</a>";html+="</div>";html+='<div id="category_'+ i+'"></div>';html+="</div>";html+="</div>";control.categoryState[i]=0;i+=1}target.innerHTML=html;if(callback&&typeof callback==="function")callback()} function populateObjectCategory(index,callback){var target=document.getElementById("category_"+index),html="",catObj=categoryInfo[index],catName=catObj.name,objData=mapCategories[index],allMarkers=markerArray,markers=[],color=catObj.icon,icon,length=objData.length,i=0,obj,name,lat,lon,marker;while(i<length){obj=objData[i];name=obj.name;lat=obj.lat;lon=obj.lon;icon=iconpath+color+"/"+(i+1)+".png";code=obj.code;marker=createMarker(lat,lon,name,icon);html+=buildCatObject(i,index,name,color,code);createInfoWindow(marker, obj,catName);markers.push(marker);i+=1}target.innerHTML=html;allMarkers[index]=markers;if(callback&&typeof callback==="function")callback()} function populatePolygonCategory(index,callback){var target=doc.getElementById("category_"+index),html="",catObj=categoryInfo[index],objData=mapCategories[index],mapKeyTarget=$(".map_key_"+catObj.name),oldKeyHTML=mapKeyTarget.html(),mapKey="",thisData,icon,length=objData.length,i=0,name,polygonLayer,polygonFile,layers=[];while(i<length){thisData=objData[i];html+='<a class="object polygon" id="layer_cat_'+i+'" href="#'+thisData.code+'">';html+='<div class="polygon_key" id="poly_'+thisData.name+'" style="border-color:'+ thisData.borderColor+"; background-color:"+thisData.fillColor+'"><span>&nbsp;</span></div>';html+='<div class="object_name polygon">'+thisData.name+"</div>";html+="</a>";mapKey+='<div class="polygon_key" id="poly_key_'+thisData.code+'" style="border-color:'+thisData.borderColor+"; background-color:"+thisData.fillColor+'">'+thisData.code+"</div>";polygonFile=thisData.map;polygonLayer=new google.maps.KmlLayer(polygonFile,{suppressInfoWindows:false,preserveViewport:true});layers.push(polygonLayer);i+= 1}markerArray[index]=layers;target.innerHTML=html;mapKeyTarget.html(oldKeyHTML+mapKey);if(callback&&typeof callback==="function")callback()}function toggleMarkerVisibility(index,newState){var array=markerArray[index],arrayLength=array.length,i=0;if(newState===1)while(i<arrayLength){array[i].setVisible(true);i+=1}else while(i<arrayLength){array[i].setVisible(false);i+=1}} function togglePolygonVisibility(obj,catIndex,layerIndex,callback){obj=obj.find("span");var layer=markerArray[catIndex][layerIndex],code=mapCategories[catIndex][layerIndex].code,catKey=$(".map_key_"+categoryInfo[catIndex].name),keyObj=$("#map_keys "+"#poly_key_"+code),active=obj.hasClass("icon-checkmark");if(active===true){layer.setMap(null);obj.stop().toggleClass("icon-checkmark");keyObj.stop().toggleClass("active_key");if(catKey.children(".active_key").length<1)catKey.hide()}else{layer.setMap(map); obj.stop().toggleClass("icon-checkmark");catKey.show();keyObj.toggleClass("active_key")}if(callback&&typeof callback==="function")callback()}function togglePolyKey(catIndex){var catKey=$(".map_key_"+categoryInfo[catIndex].name);catKey.stop().fadeToggle()} function setOptions(){myLatlng=new google.maps.LatLng(43.815045,-111.783515);myOptions={zoom:16,center:myLatlng,mapTypeId:google.maps.MapTypeId.HYBRID,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.TERRAIN]}}}function setMap(){map=new google.maps.Map(doc.getElementById("map_canvas"),myOptions)}function setInfoWindow(){infoWindow=new google.maps.InfoWindow} function setCampusLayer(){campusLayer=new google.maps.KmlLayer(campusFile,{suppressInfoWindows:true,map:map,preserveViewport:true,zoom:18});campusLayer.setMap(map)}function runPopulators(callback){var i=0,length=categoryInfo.length,type;while(i<length){type=categoryInfo[i].type;if(type===0)populateObjectCategory(i);else if(type===1)populatePolygonCategory(i);i+=1}if(callback&&typeof callback==="function")callback()} function setMenu(newState){var menu=doc.getElementById("menu"),notification=doc.getElementById("notification"),currentDevice=control.currentDevice;if(currentDevice!==0){menu=$("#menu");notification=$("#notification")}if(newState===0){if(currentDevice===0){menu.style.display="none";notification.style.display="block"}else{menu.stop().fadeOut(300);notification.stop().fadeIn(300)}control.menuState=0}else{if(currentDevice===0){menu.style.display="block";notification.style.display="none"}else{menu.stop().fadeIn(300); notification.stop().fadeOut(300)}control.menuState=1}}function toggleMenu(){var menuState=control.menuState;if(menuState===0)setMenu(1);else setMenu(0)}function bindCategoryToggle(callback){$(".category_bar").on("click",function(event){event.preventDefault();openCategory(this)});if(callback&&typeof callback==="function")callback()} function openCategory(obj){infoWindow.close();var device=control.currentDevice,parent=obj.parentNode,index=parent.id.substr(4),catState=control.categoryState[index],child=parent.children[1],display=child.style.display,polygon=$(obj).hasClass("cat_polygon");if(device===1)child=$(obj).next("div");if(catState===0){if(device===0)child.style.display="block";else child.slideToggle(200);if(polygon===false)toggleMarkerVisibility(index,1);catState=1}else{if(device===0)child.style.display="none";else child.slideToggle(200); if(polygon===false)toggleMarkerVisibility(index,0);catState=0}control.categoryState[index]=catState}function bindPolygonToggle(callback){$(".object.polygon").click(function(event){event.stopPropagation();openPolygon(this)});$(".close").click(function(event){event.stopPropagation();event.preventDefault();var catIndex=$(this).parent().attr("id").substr(9);togglePolyKey(catIndex)});if(callback&&typeof callback==="function")callback()} function openPolygon(obj){var obj=$(obj),catIndex=obj.parent().attr("id").substr(9),layerIndex=obj.attr("id").substr(10);togglePolygonVisibility(obj,catIndex,layerIndex)}function bindMenuObjects(callback){$(".object.marker_object").click(function(event){event.stopPropagation();openObject(this)});if(callback&&typeof callback==="function")callback()} function openObject(obj){var catIndex=obj.id.charAt(4),objIndex=obj.id.substr(6),thisMarker=markerArray[catIndex][objIndex],device=control.currentDevice;displayPoint(thisMarker);if(device===0)setMenu(0)}function typeToggle(callback){google.maps.event.addListener(map,"maptypeid_changed",function(){document.getElementById("notification").className=map.getMapTypeId()});if(callback&&typeof callback==="function")callback()} function bindSearch(callback){$("#object_search input").keyup(function(){performSearch(this.value.toLowerCase())});$("#object_search span").click(function(){$("#object_search input").val("");performSearch("");$("#object_search input").focus()});if(callback&&typeof callback==="function")callback()} function performSearch(val){if(val!=""){mapCategories=$.extend(true,[],fullMapCategories);var objects=mapCategories;for(var i=0,len=objects.length;i<len;i++)for(var j=0,numObjects=objects[i].length;j<numObjects;j++)if(objects[i][j].name.toLowerCase().indexOf(val)===-1){objects[i].splice(j,1);numObjects--;j--}clearAllMarkers();runPopulators(function(){bindPolygonToggle(function(){bindMenuObjects()})});openAllCategories()}else{$(".object.polygon span").removeClass("icon-checkmark");mapCategories=fullMapCategories; clearAllMarkers();runPopulators(function(){bindPolygonToggle(function(){bindMenuObjects()})});$(".category_bar").each(function(){var parent=this.parentNode,index=parent.id.substr(4),catState=control.categoryState[index];if(catState===1)openCategory(this)})}} function openAllCategories(state){$(".category_bar").each(function(){var objects=mapCategories;var parent=this.parentNode,index=parent.id.substr(4),catState=control.categoryState[index];var numberObjects=objects[index].length;if(numberObjects!==0)if(catState===0)openCategory(this);else if(!$(this).hasClass("cat_polygon"))toggleMarkerVisibility(index,1);else $(".object.polygon").each(function(){var layer=this.id.substr(10);togglePolygonVisibility($(this),index,layer)});else if(catState===1)openCategory(this)})} function clearAllMarkers(state){var markers=markerArray;$("#map_keys .polygon_key").remove();for(var i=0,len=markers.length;i<len;i++){if($(".object.polygon .icon-checkmark").length===0)$("#poly_key_"+i).hide();for(var j=0,lenTwo=markers[i].length;j<lenTwo;j++)try{markers[i][j].setVisible(false)}catch(e){markers[i][j].setMap(null)}}markers=[]} function initialize(callback){console.time("initialize js chain until ready");setOptions();setAllControls();setMap();loadProgress(10);setInfoWindow();setCampusLayer();loadProgress(80);loadCategoryInfoFile(function(){populateCategoryInfo(function(){loadCategoryFile(function(){runPopulators(function(){bindCategoryToggle(function(){bindPolygonToggle(function(){bindMenuObjects(function(){typeToggle(function(){google.maps.event.addListenerOnce(map,"tilesloaded",function(){loadComplete();setMapHeight(); openSingleBuilding();bindSearch()})})})})})})})})});if(callback&&typeof callback==="function")callback()} function openSingleBuilding(){if(window.location.hash){var code=window.location.hash.substr(1);var indexes=getObjectIndexes(code);if(indexes!=null){openCategory($("#cat_"+indexes.cat+" .category_bar")[0]);try{openObject(document.getElementById("obj_"+indexes.cat+"-"+indexes.obj))}catch(error){try{openPolygon(document.getElementById("layer_cat_"+indexes.obj))}catch(error){console.log(error)}}if(control.currentDevice==0)toggleMenu()}}} function resizeStack(){var device=detectDevice();setDevice(device,function(){setMapHeight()})}$win.resize(function(){clearTimeout(doResize);doResize=setTimeout(function(){resizeStack()},100)});$win.load(function(){initialize();$("#map_canvas").click(function(event){event.stopPropagation();var device=control.currentDevice;if($(this)!==$("#menu_button")&&device!==1)setMenu(0)});$("#heading, #menu_button").click(function(event){event.stopPropagation();event.preventDefault();toggleMenu()})}); function getObjectIndexes(code){var cats=mapCategories;try{if(code==""||code==null)throw"code can not be empty to find it";else{var found=false;var numberOfCategories=cats.length;var indexes=new Object;for(var i=0;i<numberOfCategories&&found==false;i++){var numberOfObjects=cats[i].length;for(var j=0;j<numberOfObjects&&found==false;j++)if(cats[i][j]["code"]==code){found=true;indexes.cat=i;indexes.obj=j}}if(found)return indexes;else throw"could not find object";}}catch(e){console.log(e);return null}} ;